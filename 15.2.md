# Домашнее задание к занятию «Вычислительные мощности. Балансировщики нагрузки»  - Леонид Хорошев

---
## Задание 1. Yandex Cloud 

**Что нужно сделать**

1. Создать бакет Object Storage и разместить в нём файл с картинкой:

Создать бакет в Object Storage с произвольным именем (например, _имя_студента_дата_).
Задание выполняем на основе [кода](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/hw-15.1/main.tf) из предыдущего домашнего задания. В конце выполнения домашнего задания, те ресурсы, которые окажутся невостребованы - будут закомментированы.

Чтобы наша конструкция заработала, необходимо вначале создать новый сервисный аккаунт , для которого установить необходимые роли, позволяющие создавать хранилище и добавлять туда объекты и сервисный ключ
```tf
resource "yandex_iam_service_account" "sa" {
  name = var.sa_name
}

resource "yandex_resourcemanager_folder_iam_member" "sa-admin" {
  folder_id = var.folder_id
  role      = "storage.admin"
  member    = "serviceAccount:${yandex_iam_service_account.sa.id}"
}

resource "yandex_resourcemanager_folder_iam_member" "sa-storage-put" {
  folder_id = var.folder_id
  role      = "storage.uploader"
  member    = "serviceAccount:${yandex_iam_service_account.sa.id}"
}

resource "yandex_iam_service_account_static_access_key" "static-key" {
  service_account_id = yandex_iam_service_account.sa.id
  description        = "static access key for object storage"
}
```
Далее добавляем код для создания хранилища:
```tf
resource "yandex_storage_bucket" "mystorage" {
  bucket                = "${var.student_name}-${formatdate("YYYYMMDD", timestamp())}"
  access_key            = yandex_iam_service_account_static_access_key.static-key.access_key
  secret_key            = yandex_iam_service_account_static_access_key.static-key.secret_key
  acl                   = var.acl
}
```
Скачаем файл, который будем хранить в бакете.
```
wget https://klike.net/uploads/posts/2023-01/1674457674_3-77.jpg
cp 1674457674_3-77.jpg image.jpg
rm 1674457674_3-77.jpg
```
Добавляем блок, позволяющий загружать картинку в хранилище в наш код
```tf
resource "yandex_storage_object" "image" {
  access_key            = yandex_iam_service_account_static_access_key.static-key.access_key
  secret_key            = yandex_iam_service_account_static_access_key.static-key.secret_key
  bucket                = "${var.student_name}-${formatdate("YYYYMMDD", timestamp())}"
  key                   = var.image_file_name
  source                = var.image_file_path
  depends_on            = [yandex_storage_bucket.mystorage]
  acl                   = var.acl
}
```
Сделать файл доступным из интернета.

Для обеспечения доступности файла переменная `acl` установлена в значении `public-read`.

Разворачиваем инфраструктуру и проверяем доступность картинки
```
terraform plan
terraform apply
```

![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.1.png)
![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.2.png)
![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.3.png)

Проверяем доступность нашей картинки по ссылке `https://storage.yandexcloud.net/khoroshevleonid-20240716/image.jpg`

![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.4.png)


2. Создать группу ВМ в public подсети фиксированного размера с шаблоном LAMP и веб-страницей, содержащей ссылку на картинку из бакета:

Создать Instance Group с тремя ВМ и шаблоном LAMP. Для LAMP рекомендуется использовать `image_id = fd827b91d99psvq5fjit`.
Для создания стартовой веб-страницы рекомендуется использовать раздел `user_data` в [meta_data](https://cloud.yandex.ru/docs/compute/concepts/vm-metadata).

В разделе `metadata` в качестве пользовательских данных используется файл `cloud-init.yaml` следующей конфигурации
```yml
#cloud-config
users:
  - name: leo
    ssh_authorized_keys:
      - ssh-rsa 
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    groups: sudo
    shell: /bin/bash
package_update: true
package_upgrade: true
write_files:
  - path: /var/www/html/index.html
    content: |
      <html>
      <head><title>Welcome to LAMP</title></head>
      <body>
         <h1>Welcome to LAMP</h1>
         <p>This is a LAMP server.</p>
         <img src="https://storage.yandexcloud.net/khoroshevleonid-20240716/image.jpg" />
      </body>
      </html>
```

Добавляем прав нашему сервисному аккаунту
```tf
resource "yandex_resourcemanager_folder_iam_member" "sa-vpc-user" {
  folder_id = var.folder_id
  role      = "vpc.user"
  member    = "serviceAccount:${yandex_iam_service_account.sa.id}"
}

resource "yandex_resourcemanager_folder_iam_member" "sa-editor" {
  folder_id = var.folder_id
  role      = "editor"
  member    = "serviceAccount:${yandex_iam_service_account.sa.id}"
}
```
Создаем группу виртуальных машин
```tf
resource "yandex_compute_instance_group" "lamp_group" {
  name = "lamp-group"
  service_account_id = yandex_iam_service_account.sa.id
  instance_template {
    platform_id = var.lamp_platform
    resources {
      memory = var.lamp_memory
      cores  = var.lamp_cores
      core_fraction = var.lamp_core_fraction
  }
  boot_disk {
    initialize_params {
      image_id = var.lamp_disk_image_id
    }
  }
  network_interface {
    subnet_ids = [yandex_vpc_subnet.public_subnet.id]
    nat = var.nat
  }
  scheduling_policy {
    preemptible = var.lamp_scheduling_policy
  }

  metadata = {
      user-data = "${file("/home/leo/clopro-homeworks/cloud-init.yaml")}"
   }
  }

  scale_policy {
    fixed_scale {
      size = var.lamp_size
    }
  }

  deploy_policy {
    max_unavailable = var.lamp_max_unavailable
    max_expansion   = var.lamp_max_expansion
  }

  health_check {
    interval = var.lamp_interval
    timeout  = var.lamp_timeout
    healthy_threshold   = var.healthy_threshold
    unhealthy_threshold = var.unhealthy_threshold
    }
  }

  allocation_policy {
    zones = [var.subnet_zone]
  }
 load_balancer {
        target_group_name = "lamp-group"
  }
}
```
Разместить в стартовой веб-странице шаблонной ВМ ссылку на картинку из бакета.

Ссылка размещена в файле [cloud-init.yaml]()
```tf
write_files:
  - path: /var/www/html/index.html
    content: |
      <html>
      <head><title>Welcome to LAMP</title></head>
      <body>
         <h1>Welcome to LAMP</h1>
         <p>This is a LAMP server.</p>
         <img src="https://storage.yandexcloud.net/khoroshevleonid-20240716/image.jpg" />
      </body>
      </html>
```
Настроить проверку состояния ВМ.

Проверка состояния настроена в [main.tf]()
```tf
 health_check {
    interval = var.lamp_interval
    timeout  = var.lamp_timeout
    healthy_threshold   = var.healthy_threshold
    unhealthy_threshold = var.unhealthy_threshold
    }
```
 
Подключаем группу к сетевому балансировщику:

Создать сетевой балансировщик
```tf
resource "yandex_lb_network_load_balancer" "balancer" {
  name        = var.balancer_name
  folder_id   = var.folder_id
  listener {
    name = var.balancer_listener_name
    port = var.balancer_listener_port
    external_address_spec {
      ip_version = "ipv4"
    }
  }
attached_target_group {
    target_group_id = yandex_compute_instance_group.lamp_group.load_balancer.0.target_group_id
    healthcheck {
      name = var.balancer_listener_name
      interval = var.balancer_interval
      timeout = var.balancer_timeout
      unhealthy_threshold = var.unhealthy_threshold
      healthy_threshold = var.healthy_threshold
      http_options {
        port = var.balancer_listener_port
        path = "/"
      }
    }
  }
}
```

Создаем ресурсы и проверяем их доступность
```
terraform plan
terraform apply
```

![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.4.png)
![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.5.png)
![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.6.png)
![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.7.png)
![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.8.png)

Проверяем работоспособность, удалив одну или несколько ВМ.

Отключаем 2 виртуальные машины

![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.9.png)

Проверяем результат

![Alt_text](https://github.com/LeonidKhoroshev/clopro-homeworks/blob/main/screenshots/cloud2.10.png)

4. (дополнительно)* Создать Application Load Balancer с использованием Instance group и проверкой состояния.

Полезные документы:

- [Compute instance group](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/compute_instance_group).
- [Network Load Balancer](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/lb_network_load_balancer).
- [Группа ВМ с сетевым балансировщиком](https://cloud.yandex.ru/docs/compute/operations/instance-groups/create-with-balancer).

---

